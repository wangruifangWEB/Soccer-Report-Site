<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">

    <script src="static/js/jquery.min.js"></script>

    <script src="static/js/underscore-min.js"></script>

    <link rel="stylesheet" type="text/css" href="static/css/bootstrap.min.css">
    <script src="static/js/bootstrap.min.js"></script>

    <script src="static/js/echarts.min.js"></script>

    <script src="static/js/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" type="text/css" href="static/css/dataTables.bootstrap.min.css">
    <script src="static/js/dataTables.bootstrap.min.js"></script>

    <script type="text/javascript">
        function encodeURI(part) {
            return encodeURIComponent(part).replace(/%20/g, "+");
        }

        function visualize(selector, spec, data) {
            var chart = echarts.init($(selector)[0]);
            var ecSpec = spec.spec;
            var type = spec.type;
            var stack = spec.stack;

            ecSpec.tooltip = {
                "trigger": "axis",
                "axisPointer" : {
                    "type" : "shadow"
                }
            };

            ecSpec.toolbox = {
                "feature" : {
                    "saveAsImage" : {
                        "title": "Save as Image"
                    }
                },
                "right": 50
            };

            if ("columnField" in spec) {
                ecSpec.xAxis.data = _.uniq(_.map(data, r => r[spec.xField]));

                ecSpec.series = _.map(
                    _.groupBy(data, r => r[spec.columnField]),
                    (g, k) => {
                        return {
                            name: k,
                            type: type,
                            data: _.map(g, r => r[spec.yField]),
                            stack: stack,
                            barMaxWidth: '50',
                            barGap: "10%"
                        };
                    }
                );

                ecSpec.legend = {
                    data: _.map(data, r => r[spec.columnField])
                };
            }
            else if ("rowField" in spec) {
                ecSpec.yAxis.data = _.uniq(_.map(data, r => r[spec.yField]));

                ecSpec.series = _.map(
                    _.groupBy(data, r => r[spec.rowField]),
                    (g, k) => {
                        return {
                            name: k,
                            type: type,
                            data: _.map(g, r => r[spec.xField]),
                            stack: stack,
                            barMaxWidth: '50',
                            barGap: "10%"
                        };
                    }
                );

                ecSpec.legend = {
                    data: _.map(data, r => r[spec.rowField])
                };
            }
            else {
                ecSpec.xAxis.data = _.uniq(_.map(data, r => r[spec.xField]));

                ecSpec.series = [{
                    data: _.map(data, r => r[spec.yField]),
                    type: type,
                    barMaxWidth: '50',
                    barGap: "10%",
                    markLine: {
                        data: [
                            {
                                type: "average"
                            }
                        ],
                        lineStyle: {
                            normal: {
                                color: "rgb(0, 102, 153)",
                                width: 2
                            }
                        }
                    }
                }];
            }

            chart.setOption(ecSpec, true);
        }

        function selectAll(buttonObj, value) {
            var selectObj = buttonObj.parent().next();
            selectObj.children('option').prop("selected", value);
            selectObj.change();
        }

        $(document).ready(function() {
            $(".vis select[multiple]").map(function() {
                $(this).before(
                    `
                    <div style="float: right">
                        <button type="button" class="btn btn-xs btn-info btn-select-none">None</button>
                        <button type="button" class="btn btn-xs btn-info btn-select-all">All</button>
                    </div>
                    `
                );
            });

            setTimeout(() => {
                $(".btn-select-none").click(function() {
                    selectAll($(this), false);
                });

                $(".btn-select-all").click(function() {
                    selectAll($(this), true);
                });
            }, 400);

            $.getJSON("config.json", function(config) {
                var host = config.host;

                $(".vis").map(function() {
                    var id = $(this).attr('id');

                    var dataID = id;
                    if ($(this).attr('data-id') !== undefined) {
                        dataID = $(this).attr('data-id');
                    }

                    var args = [];
                    var realArgs = [];

                    $(`#${id} select`).map(function() {
                        var argName = $(this).attr("data-arg");
                        args.push(argName);
                        var realArgName = $(this).attr("data-realarg");
                        realArgs.push(realArgName !== undefined ? realArgName : argName);

                        var defaultPos = $(this).attr("data-default");

                        $.getJSON(`http://${host}/${dataID}/${argName}`, response => {
                            var list = response.data;
                            var options = "";
                            if (list.length > 0) {
                                for (var i = 0; i < list.length; i++) {
                                    options += `<option value="${list[i]}">${list[i]}</option>`;
                                }

                                $(this).html(options);
                                if (defaultPos === undefined) {
                                    if ($(this).prop("multiple")) {
                                        $(this).children(`option`).prop("selected", true);
                                    }
                                    else {
                                        $(this).children(`option:first-of-type`).prop("selected", true);
                                    }
                                }
                                else {
                                    $(this).children(`option:nth-of-type(${defaultPos})`).prop("selected", true);
                                }
                            }
                        });
                    });

                    function getArgStr() {
                        var argStr = "";
                        for (i = 0; i < args.length; i++) {
                            var key = args[i];
                            var realKey = realArgs[i];
                            var value = $(`#${id} select[data-arg=${key}]`).val();

                            if (i > 0) {
                                argStr += '&';
                            }
                            if (Array.isArray(value)) {
                                argStr += `${realKey}=` + value.join(`&${realKey}=`);
                            }
                            else {
                                argStr += `${realKey}=${encodeURI(value)}`;
                            }
                        }

                        return argStr
                    }

                    function getAction(selector, func) {
                        var target = $(selector).attr("data-target");
                        if (target === undefined) {
                            target = "func";
                        }

                        return () => $.getJSON(`http://${host}/${dataID}/${target}?${getArgStr()}`, func);
                    }

                    if ($(this).has(".vis-figure").length > 0) {
                        $.getJSON(`vis/${dataID}.json`, function(response) {
                            var spec = response;

                            var action = getAction(`#${id} .vis-figure`, function(response) {
                                visualize(`#${id} .vis-figure`, spec, response.data);
                            });

                            $(`#${id} select`).change(action);
                            setTimeout(action, 400);
                        });
                    }

                    if ($(this).has(".vis-table").length > 0) {
                        var table = null;

                        var action = getAction(`#${id} .vis-table`, function(response) {
                            if (table) {
                                table.destroy();
                                $(`#${id} .vis-table`).empty();
                            }

                            var data_tuple = [];
                            var player_name = "";
                            var last_name = "";

                            if (id === "player_table") {
                                for (i = 1; i < response.data.length; i++){
                                    player_name = response.data[i][0].split(' ');
                                    response.data[i][0] = player_name[player_name.length - 1];;
                                }
                            }

                            table = $(`#${id} .vis-table`).DataTable({
                                "data": _.rest(response.data),
                                "columns": _.map(response.data[0], v => {
                                    return {title: v};
                                }),

                                "displayLength": -1,
                                "paging": false,
                                "ordering": false,
                                "info": false,
                                "searching": false
                            })
                        });

                        $(`#${id} select`).change(action);
                        setTimeout(action, 400);
                    }
                });
            });
        });
    </script>

    <style>
        .vis > table {
            width: 100%;
        }

        .vis > table > tbody > tr > td:last-of-type {
            width: 200px;
            vertical-align: top;
        }

        .vis select {
            min-width: 50px;
            max-width: 200px;
        }
        .vis select[multiple] {
            min-height: 200px;
        }

        .vis-figure {
            height: 400px;
            min-width: 400px;
        }

        .vis-table td {
            min-width: 100px;
            white-space: nowrap;
        }

        #opposition .vis-table th {
            border: none;
        }
        #opposition .vis-table tbody {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container" style="max-width: 1000px">
        <div class="vis" id="results_graph">
            <h3>Results Graph</h3>
            <table>
                <tr>
                    <td>
                        <div class="vis-figure"></div>
                    </td>
                    <td>
                        Year
                        <select class="form-control input-sm" data-arg="year" data-default="5" multiple></select>
                    </td>
                </tr>
            </table>
        </div>

        <div class="vis" id="results_table" data-id="results_graph">
            <h3>Results Table</h3>
            <table>
                <tr>
                    <td>
                        <table class="table table-hover table-condensed vis-table" data-target="func_table"></table>
                    </td>
                    <td>
                    </td>
                </tr>
            </table>
        </div>

        <div class="vis" id="opposition">
            <h3>Opposition</h3>
            <table>
                <tr>
                    <td>
                        <div class="vis-figure"></div>
                        <div style="max-width: 800px; font-size: 12px">
                            <table class="table table-condensed vis-table" data-target="func_result"></table>
                        </div>
                    </td>
                    <td>
                        Measure
                        <select class="form-control input-sm" data-arg="measure" data-default="6"></select>
                        Opponent
                        <select class="form-control input-sm" data-arg="opponent"></select>
                    </td>
                </tr>
            </table>
        </div>

        <div class="vis" id="team_working_data_control" data-id="team_working_data">
            <h3>Team Working Data - Control</h3>
            <table>
                <tr>
                    <td>
                        <div class="vis-figure"></div>
                    </td>
                    <td>
                        Control Measure
                        <select class="form-control input-sm" data-arg="control_measure" data-realarg="measure" data-default="2"></select>
                    </td>
                </tr>
            </table>
        </div>

        <div class="vis" id="team_working_data_process" data-id="team_working_data">
            <h3>Team Working Data - Process</h3>
            <table>
                <tr>
                    <td>
                        <div class="vis-figure"></div>
                    </td>
                    <td>
                        Process Measure
                        <select class="form-control input-sm" data-arg="process_measure" data-realarg="measure" data-default="5"></select>
                    </td>
                </tr>
            </table>
        </div>

        <div class="vis" id="team_working_data_outcome" data-id="team_working_data">
            <h3>Team Working Data - Outcome</h3>
            <table>
                <tr>
                    <td>
                        <div class="vis-figure"></div>
                    </td>
                    <td>
                        Outcome Measure
                        <select class="form-control input-sm" data-arg="outcome_measure" data-realarg="measure" data-default="12"></select>
                    </td>
                </tr>
            </table>
        </div>

        <div class="vis" id="team_working_data_final" data-id="team_working_data">
            <h3>Team Working Data - Final Acts Quality</h3>
            <table>
                <tr>
                    <td>
                        <div class="vis-figure"></div>
                    </td>
                    <td>
                        Final Acts Quality Measure
                        <select class="form-control input-sm" data-arg="final_measure" data-realarg="measure" data-default="3"></select>
                    </td>
                </tr>
            </table>
        </div>

        <div class="vis" id="player_analysis_graph_control" data-id="player_analysis_graph">
            <h3>Player Analysis Graph - Control</h3>
            <table>
                <tr>
                    <td>
                        <div class="vis-figure"></div>
                    </td>
                    <td>
                        Control Measure
                        <select class="form-control input-sm" data-arg="control_measure" data-realarg="measure" data-default="2"></select>
                        Minutes
                        <select class="form-control input-sm" data-arg="minutes" data-default="9"></select>
                        Podium
                        <div class="form-inline">
                            <select class="form-control input-sm" data-arg="podium_op" data-default="2"></select>
                            <select class="form-control input-sm" data-arg="podium" data-default="5"></select>
                        </div>
                        Players
                        <select class="form-control input-sm" data-arg="players" multiple></select>
                    </td>
                </tr>
            </table>
        </div>

        <div class="vis" id="player_analysis_graph_process" data-id="player_analysis_graph">
            <h3>Player Analysis Graph - Process</h3>
            <table>
                <tr>
                    <td>
                        <div class="vis-figure"></div>
                    </td>
                    <td>
                        Process Measure
                        <select class="form-control input-sm" data-arg="process_measure" data-realarg="measure" data-default="3"></select>
                        Minutes
                        <select class="form-control input-sm" data-arg="minutes" data-default="9"></select>
                        Podium
                        <div class="form-inline">
                            <select class="form-control input-sm" data-arg="podium_op" data-default="2"></select>
                            <select class="form-control input-sm" data-arg="podium" data-default="5"></select>
                        </div>
                        Players
                        <select class="form-control input-sm" data-arg="players" multiple></select>
                    </td>
                </tr>
            </table>
        </div>

        <div class="vis" id="player_analysis_graph_outcome" data-id="player_analysis_graph">
            <h3>Player Analysis Graph - Outcome</h3>
            <table>
                <tr>
                    <td>
                        <div class="vis-figure"></div>
                    </td>
                    <td>
                        Outcome Measure
                        <select class="form-control input-sm" data-arg="outcome_measure" data-realarg="measure" data-default="12"></select>
                        Minutes
                        <select class="form-control input-sm" data-arg="minutes" data-default="9"></select>
                        Podium
                        <div class="form-inline">
                            <select class="form-control input-sm" data-arg="podium_op" data-default="2"></select>
                            <select class="form-control input-sm" data-arg="podium" data-default="5"></select>
                        </div>
                        Players
                        <select class="form-control input-sm" data-arg="players" multiple></select>
                    </td>
                </tr>
            </table>
        </div>

        <div class="vis" id="player_analysis_graph_final" data-id="player_analysis_graph">
            <h3>Player Analysis Graph - Final Acts Quality</h3>
            <table>
                <tr>
                    <td>
                        <div class="vis-figure"></div>
                    </td>
                    <td>
                        Final Acts Quality Measure
                        <select class="form-control input-sm" data-arg="final_measure" data-realarg="measure" data-default="3"></select>
                        Minutes
                        <select class="form-control input-sm" data-arg="minutes" data-default="9"></select>
                        Podium
                        <div class="form-inline">
                            <select class="form-control input-sm" data-arg="podium_op" data-default="2"></select>
                            <select class="form-control input-sm" data-arg="podium" data-default="5"></select>
                        </div>
                        Players
                        <select class="form-control input-sm" data-arg="players" multiple></select>
                    </td>
                </tr>
            </table>
        </div>

        <div class="vis" id="pass_completion_control" data-id="pass_completion">
            <h3>Pass Completion - Control</h3>
            <table>
                <tr>
                    <td>
                        <div class="vis-figure"></div>
                    </td>
                    <td>
                        Control Measure
                        <select class="form-control input-sm" data-arg="control_measure" data-realarg="measure" data-default="2"></select>
                        Player
                        <select class="form-control input-sm" data-arg="player"></select>
                    </td>
                </tr>
            </table>
        </div>

        <div class="vis" id="pass_completion_process" data-id="pass_completion">
            <h3>Pass Completion - Process</h3>
            <table>
                <tr>
                    <td>
                        <div class="vis-figure"></div>
                    </td>
                    <td>
                        Process Measure
                        <select class="form-control input-sm" data-arg="process_measure" data-realarg="measure" data-default="3"></select>
                        Player
                        <select class="form-control input-sm" data-arg="player"></select>
                    </td>
                </tr>
            </table>
        </div>

        <div class="vis" id="pass_completion_outcome_first" data-id="pass_completion">
            <h3>Pass Completion - Outcome</h3>
            <table>
                <tr>
                    <td>
                        <div class="vis-figure"></div>
                    </td>
                    <td>
                        Outcome Measure
                        <select class="form-control input-sm" data-arg="outcome_measure_first" data-realarg="measure" data-default="7"></select>
                        Player
                        <select class="form-control input-sm" data-arg="player"></select>
                    </td>
                </tr>
            </table>
        </div>

        <div class="vis" id="pass_completion_outcome_second" data-id="pass_completion">
            <h3>Pass Completion - Outcome</h3>
            <table>
                <tr>
                    <td>
                        <div class="vis-figure"></div>
                    </td>
                    <td>
                        Outcome Measure
                        <select class="form-control input-sm" data-arg="outcome_measure_second" data-realarg="measure" data-default="3"></select>
                        Player
                        <select class="form-control input-sm" data-arg="player"></select>
                    </td>
                </tr>
            </table>
        </div>

        <div class="vis" id="player_table">
            <h3>Player Table</h3>
            <table>
                <tr>
                    <td>
                        <div style="overflow: scroll; max-width: 800px;">
                            <table class="table table-hover table-condensed vis-table"></table>
                        </div>
                    </td>
                    <td>
                        Minutes
                        <select class="form-control input-sm" data-arg="minutes" data-default="9"></select>
                        Podium
                        <div class="form-inline">
                            <select class="form-control input-sm" data-arg="podium_op" data-default="2"></select>
                            <select class="form-control input-sm" data-arg="podium" data-default="5"></select>
                        </div>
                    </td>
                </tr>
            </table>
        </div>
    </div>
</body>
</html>
