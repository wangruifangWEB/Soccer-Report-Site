<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">

    <script src="static/js/jquery.min.js"></script>

    <script src="static/js/underscore-min.js"></script>

    <link rel="stylesheet" type="text/css" href="static/css/bootstrap.min.css">
    <script src="static/js/bootstrap.min.js"></script>

    <script src="static/js/echarts.min.js"></script>

    <script src="static/js/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" type="text/css" href="static/css/dataTables.bootstrap.min.css">
    <script src="static/js/dataTables.bootstrap.min.js"></script>

    <script type="text/javascript">
        function encodeURI(part) {
            return encodeURIComponent(part).replace(/%20/g, "+");
        }

        function visualize(selector, spec, data) {
            var chart = echarts.init($(selector)[0]);
            var ecSpec = spec.spec;
            var type = spec.type;
            var stack = spec.stack;

            if ("columnField" in spec) {
                ecSpec.xAxis = {
                    data: _.map(data, r => r[spec.xField])
                };

                ecSpec.series = _.map(
                    _.groupBy(data, r => r[spec.columnField]),
                    (g, k) => {
                        return {
                            name: k,
                            type: type,
                            data: _.map(g, r => r[spec.yField]),
                            stack: stack
                        };
                    }
                );
            }
            else if ("rowField" in spec) {
                ecSpec.yAxis = {
                    data: _.map(data, r => r[spec.yField])
                };

                ecSpec.series = _.map(
                    _.groupBy(data, r => r[spec.rowField]),
                    (g, k) => {
                        return {
                            name: k,
                            type: type,
                            data: _.map(g, r => r[spec.xField]),
                            stack: stack
                        };
                    }
                );
            }
            else {
                ecSpec.xAxis = {
                    data: _.map(data, r => r[spec.xField])
                };

                ecSpec.series = [{
                    data: _.map(data, r => r[spec.yField]),
                    type: type,
                }];
            }

            chart.setOption(ecSpec);
        }

        $(document).ready(function() {
            $.getJSON("config.json", function(config) {
                var host = config.host;

                $(".vis").map(function() {
                    var id = $(this).attr('id');

                    var dataID = id;
                    if ($(this).attr('data-id') !== undefined) {
                        dataID = $(this).attr('data-id');
                    }

                    var args = [];
                    var realArgs = [];

                    $(`#${id} > select`).map(function() {
                        var argName = $(this).attr("data-arg");
                        args.push(argName);
                        var realArgName = $(this).attr("data-realarg");
                        realArgs.push(realArgName !== undefined ? realArgName : argName);

                        var defaultPos = $(this).attr("data-default");

                        $.getJSON(`http://${host}/${dataID}/${argName}`, response => {
                            var list = response.data;
                            var options = "";
                            if (list.length > 0) {
                                for (var i = 0; i < list.length; i++) {
                                    options += `<option value="${list[i]}">${list[i]}</option>`;
                                }

                                $(this).html(options);
                                if (defaultPos === undefined) {
                                    if ($(this).prop("multiple")) {
                                        $(this).children(`option`).prop("selected", true);
                                    }
                                    else {
                                        $(this).children(`option:first-of-type`).prop("selected", true);
                                    }
                                }
                                else {
                                    $(this).children(`option:nth-of-type(${defaultPos})`).prop("selected", true);
                                }
                            }
                        });
                    });

                    function getArgStr() {
                        var argStr = "";
                        for (i = 0; i < args.length; i++) {
                            var key = args[i];
                            var realKey = realArgs[i];
                            var value = $(`#${id} > select[data-arg=${key}]`).val();

                            if (i > 0) {
                                argStr += '&';
                            }
                            if (Array.isArray(value)) {
                                argStr += `${realKey}=` + value.join(`&${realKey}=`);
                            }
                            else {
                                argStr += `${realKey}=${encodeURI(value)}`;
                            }
                        }

                        return argStr
                    }

                    function getAction(func) {
                        return () => $.getJSON(`http://${host}/${dataID}/func?${getArgStr()}`, func);
                    }

                    var action;

                    if ($(this).hasClass("vis-figure")) {
                        $.getJSON(`vis/${dataID}.json`, function(response) {
                            var spec = response;

                            action = getAction(function(response) {
                                visualize(`#${id} > div`, spec, response.data);
                            });

                            $(`#${id} > select`).change(action);
                            setTimeout(action, 400);
                        });
                    }
                    else if ($(this).hasClass("vis-table")) {
                        var table = null;

                        action = getAction(function(response) {
                            var columns = [];
                            var keys = Object.keys(response.data[0]);
                            for (var i = 0; i < keys.length; i++) {
                                columns.push({data: keys[i], title: keys[i]});
                            }
                            if (table) {
                                table.destroy();
                                $(`#${id} > table`).empty();
                            }
                            table = $(`#${id} > table`).DataTable({
                                "data": response.data,
                                "columns": columns,

                                "displayLength": -1,
                                "paging": false,
                                "ordering": false,
                                "info": false,
                                "searching": false
                            })
                        });

                        $(`#${id} > select`).change(action);
                        setTimeout(action, 400);
                    }
                });
            });
        });
    </script>

    <style>
        .vega-actions a {
            margin-right: 10px;
        }

        .vis-figure > div {
            height: 400px;
        }
    </style>
</head>
<body>
    <div class="container" style="max-width:1000px">
        <div class="form-inline vis vis-figure" id="opposition">
            <h3>Opposition</h3>
            Measure
            <select class="form-control" data-arg="measure" data-default="6"></select>
            Opponent
            <select class="form-control" data-arg="opponent"></select>
            <div></div>
        </div>

        <div class="form-inline vis vis-figure" id="player_analysis_graph_control" data-id="player_analysis_graph">
            <h3>Player Analysis Graph - Control</h3>
            Control Measure
            <select class="form-control" data-arg="control_measure" data-realarg="measure" data-default="2"></select>
            Minutes
            <select class="form-control" data-arg="minutes" data-default="6"></select>
            Podium
            <select data-arg="podium" data-default="5"></select>
            Players
            <select class="form-control" data-arg="players" multiple></select>
            <div></div>
        </div>

        <div class="form-inline vis vis-figure" id="player_analysis_graph_process" data-id="player_analysis_graph">
            <h3>Player Analysis Graph - Process</h3>
            Process Measure
            <select class="form-control" data-arg="process_measure" data-realarg="measure" data-default="3"></select>
            Minutes
            <select class="form-control" data-arg="minutes" data-default="6"></select>
            Podium
            <select class="form-control" data-arg="podium" data-default="5"></select>
            Players
            <select class="form-control" data-arg="players" multiple></select>
            <div></div>
        </div>

        <div class="form-inline vis vis-figure" id="player_analysis_graph_outcome" data-id="player_analysis_graph">
            <h3>Player Analysis Graph - Outcome</h3>
            Outcome Measure
            <select class="form-control" data-arg="outcome_measure" data-realarg="measure" data-default="12"></select>
            Minutes
            <select class="form-control" data-arg="minutes" data-default="6"></select>
            Podium
            <select class="form-control" data-arg="podium" data-default="5"></select>
            Players
            <select class="form-control" data-arg="players" multiple></select>
            <div></div>
        </div>

        <div class="form-inline vis vis-figure" id="player_analysis_graph_final" data-id="player_analysis_graph">
            <h3>Player Analysis Graph - Final Acts Quality</h3>
            Final Acts Quality Measure
            <select class="form-control" data-arg="final_measure" data-realarg="measure" data-default="3"></select>
            Minutes
            <select class="form-control" data-arg="minutes" data-default="6"></select>
            Podium
            <select class="form-control" data-arg="podium" data-default="5"></select>
            Players
            <select class="form-control" data-arg="players" multiple></select>
            <div></div>
        </div>

        <div class="form-inline vis vis-figure" id="results_graph">
            <h3>Results Graph</h3>
            Year
            <select class="form-control" data-arg="year"></select>
            <select class="form-control" data-arg="format_figure" data-realarg="format" style="display: none"></select>
            <div></div>
        </div>

        <div class="form-inline vis vis-table" id="results_table" data-id="results_graph">
            <h3>Results Table</h3>
            <table class="table"></table>
            <select class="form-control" data-arg="format_table" data-realarg="format" style="display: none"></select>
        </div>

        <div class="form-inline vis vis-figure" id="pass_completion_control" data-id="pass_completion">
            <h3>Pass Completion - Control</h3>
            Control Measure
            <select class="form-control" data-arg="control_measure" data-realarg="measure" data-default="2"></select>
            Player
            <select class="form-control" data-arg="player"></select>
            <div></div>
        </div>

        <div class="form-inline vis vis-figure" id="pass_completion_process" data-id="pass_completion">
            <h3>Pass Completion - Process</h3>
            Process Measure
            <select class="form-control" data-arg="process_measure" data-realarg="measure" data-default="3"></select>
            Player
            <select class="form-control" data-arg="player"></select>
            <div></div>
        </div>

        <div class="form-inline vis vis-figure" id="pass_completion_outcome_first" data-id="pass_completion">
            <h3>Pass Completion - Outcome First</h3>
            Outcome Measure
            <select class="form-control" data-arg="outcome_measure_first" data-realarg="measure" data-default="7"></select>
            Player
            <select class="form-control" data-arg="player"></select>
            <div></div>
        </div>

        <div class="form-inline vis vis-figure" id="pass_completion_outcome_second" data-id="pass_completion">
            <h3>Pass Completion - Outcome Second</h3>
            Outcome Measure
            <select class="form-control" data-arg="outcome_measure_second" data-realarg="measure" data-default="3"></select>
            Player
            <select class="form-control" data-arg="player"></select>
            <div></div>
        </div>

        <div class="form-inline vis vis-table" id="player_table">
            <h3>Player Table</h3>
            Minutes
            <select class="form-control" data-arg="minutes" data-default="6"></select>
            Podium
            <select class="form-control" data-arg="podium" data-default="5"></select>
            <table class="table"></table>
        </div>
    </div>
</body>
</html>
