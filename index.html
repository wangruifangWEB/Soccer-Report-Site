<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">

    <script src="static/js/jquery.min.js"></script>

    <script src="static/js/underscore-min.js"></script>

    <link rel="stylesheet" type="text/css" href="static/css/bootstrap.min.css">
    <script src="static/js/bootstrap.min.js"></script>

    <script src="static/js/d3.min.js"></script>
    <script src="static/js/vega.min.js"></script>
    <script src="static/js/vega-lite.min.js"></script>
    <script src="static/js/vega-embed.min.js"></script>

    <script type="text/javascript">
        function encodeURI(part) {
            return encodeURIComponent(part).replace(/%20/g, "+");
        }

        function visualize(selector, spec) {
            vg.embed(selector, {
                mode: "vega-lite",
                spec: spec,
                renderer: "svg"
            });
        }

        $(document).ready(function() {
            $.getJSON("config.json", function(config) {
                var host = config.host;

                $(".vis").map(function() {
                    var id = $(this).attr('id');

                    var args = [];

                    $(`#${id} > select`).map(function() {
                        var argName = $(this).attr("data-arg");
                        args.push(argName);

                        $.getJSON(`http://${host}/${id}/${argName}`, response => {
                            var list = response.data;
                            var options = "";
                            if (list.length > 0) {
                                for (var i = 0; i < list.length; i++) {
                                    options += `<option value="${list[i]}">${list[i]}</option>`;
                                }

                                $(this).html(options);
                                $(this).children(`option:first-of-type`).prop("selected", true);
                            }
                        });
                    });

                    $.getJSON(`vis/${id}.json`, function(response) {
                        var vlSpec = response;

                        $(`#${id} > select`).change(function() {
                            var argStr = "";
                            for (i = 0; i < args.length; i++) {
                                var key = args[i];
                                var value = $(`#${id} > select[data-arg=${key}]`).val();

                                if (i > 0) {
                                    argStr += '&';
                                }
                                if (Array.isArray(value)) {
                                    argStr += `${key}=` + value.join(`&${key}=`);
                                }
                                else {
                                    argStr += `${key}=${encodeURI(value)}`;
                                }
                            }

                            $.getJSON(`http://${host}/${id}/func?${argStr}`, function(response) {
                                vlSpec.data.values = response.data;
                                visualize(`#${id} > div`, vlSpec);
                            });
                        });

                        setTimeout(function() {
                            $(`#${id} > select:first-of-type`).trigger("change");
                        }, 200);
                    });
                });
            });
        });
    </script>

    <style>
        .vega-actions a {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div style="max-width:1000px">
        <div class="vis" id="opposition">
            <select data-arg="measure"></select>
            <select data-arg="opponent"></select>
            <div></div>
        </div>

        <div class="vis" id="player_analysis_graph">
            <select data-arg="measure"></select>
            <select data-arg="players" multiple></select>
            <div></div>
        </div>
    </div>
</body>
</html>
