<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">

    <script src="static/js/jquery.min.js"></script>

    <script src="static/js/underscore-min.js"></script>

    <link rel="stylesheet" type="text/css" href="static/css/bootstrap.min.css">
    <script src="static/js/bootstrap.min.js"></script>

    <script src="static/js/d3.min.js"></script>
    <script src="static/js/vega.min.js"></script>
    <script src="static/js/vega-lite.min.js"></script>
    <script src="static/js/vega-embed.min.js"></script>

    <script src="static/js/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" type="text/css" href="static/css/dataTables.bootstrap.min.css">
    <script src="static/js/dataTables.bootstrap.min.js"></script>

    <script type="text/javascript">
        function encodeURI(part) {
            return encodeURIComponent(part).replace(/%20/g, "+");
        }

        function visualize(selector, spec) {
            vg.embed(selector, {
                mode: "vega-lite",
                spec: spec,
                renderer: "svg"
            });
        }

        $(document).ready(function() {
            $.getJSON("config.json", function(config) {
                var host = config.host;

                $(".vis").map(function() {
                    var id = $(this).attr('id');

                    var dataID = id;
                    if ($(this).attr('data-id') !== undefined) {
                        dataID = $(this).attr('data-id');
                    }

                    var args = [];
                    var realArgs = [];

                    $(`#${id} > select`).map(function() {
                        var argName = $(this).attr("data-arg");
                        args.push(argName);
                        var realArgName = $(this).attr("data-realarg");
                        realArgs.push(realArgName !== undefined ? realArgName : argName);

                        $.getJSON(`http://${host}/${dataID}/${argName}`, response => {
                            var list = response.data;
                            var options = "";
                            if (list.length > 0) {
                                for (var i = 0; i < list.length; i++) {
                                    options += `<option value="${list[i]}">${list[i]}</option>`;
                                }

                                $(this).html(options);
                                $(this).children(`option:first-of-type`).prop("selected", true);
                            }
                        });
                    });

                    function getArgStr() {
                        var argStr = "";
                        for (i = 0; i < args.length; i++) {
                            var key = args[i];
                            var realKey = realArgs[i];
                            var value = $(`#${id} > select[data-arg=${key}]`).val();

                            if (i > 0) {
                                argStr += '&';
                            }
                            if (Array.isArray(value)) {
                                argStr += `${realKey}=` + value.join(`&${realKey}=`);
                            }
                            else {
                                argStr += `${realKey}=${encodeURI(value)}`;
                            }
                        }

                        return argStr
                    }

                    function getAction(func) {
                        return () => $.getJSON(`http://${host}/${dataID}/func?${getArgStr()}`, func);
                    }

                    var action;

                    if ($(this).hasClass("vis-figure")) {
                        $.getJSON(`vis/${id}.json`, function(response) {
                            var vlSpec = response;

                            action = getAction(function(response) {
                                vlSpec.data.values = response.data;
                                visualize(`#${id} > div`, vlSpec);
                            });

                            $(`#${id} > select`).change(action);
                            setTimeout(action, 200);
                        });
                    }
                    else if ($(this).hasClass("vis-table")) {
                        var table = null;

                        action = getAction(function(response) {
                            var columns = [];
                            var keys = Object.keys(response.data[0]);
                            for (var i = 0; i < keys.length; i++) {
                                columns.push({data: keys[i], title: keys[i]});
                            }
                            if (table) {
                                table.destroy();
                                $(`#${id} > table`).empty();
                            }
                            table = $(`#${id} > table`).DataTable({
                                "data": response.data,
                                "columns": columns,

                                "displayLength": -1,
                                "paging": false,
                                "ordering": false,
                                "info": false,
                                "searching": false
                            })
                        });

                        $(`#${id} > select`).change(action);
                        setTimeout(action, 200);
                    }
                });
            });
        });
    </script>

    <style>
        .vega-actions a {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container" style="max-width:1000px">
        <div class="vis vis-figure" id="opposition">
            <h3>Opposition</h3>
            <select data-arg="measure"></select>
            <select data-arg="opponent"></select>
            <div></div>
        </div>

        <div class="vis vis-figure" id="player_analysis_graph">
            <h3>Player Analysis Graph</h3>
            <select data-arg="measure"></select>
            <select data-arg="players" multiple></select>
            <div></div>
        </div>

        <div class="vis vis-figure" id="results_graph">
            <h3>Results Graph</h3>
            <select data-arg="year"></select>
            <div></div>
        </div>

        <div class="vis vis-figure" id="results_table" data-id="results_graph">
            <h3>Results Table</h3>
            <div></div>
        </div>

        <div class="vis vis-figure" id="pass_completion_process" data-id="pass_completion">
            <h3>Pass Completion</h3>
            <select data-arg="process_measure" data-realarg="measure"></select>
            <select data-arg="player"></select>
            <div></div>
        </div>

        <div class="vis vis-figure" id="pass_completion_control" data-id="pass_completion">
            <h3>Pass Completion</h3>
            <select data-arg="control_measure" data-realarg="measure"></select>
            <select data-arg="player"></select>
            <div></div>
        </div>

        <div class="vis vis-table" id="player_table">
            <h3>Player Table</h3>
            <select data-arg="minutes"></select>
            <select data-arg="podium"></select>
            <table class="table"></table>
        </div>
    </div>
</body>
</html>
