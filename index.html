<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">

        <script src="static/js/jquery.min.js"></script>
        <script src="static/js/jquery.visible.min.js"></script>

        <script src="static/js/js.cookie.js"></script>

        <script src="static/js/underscore-min.js"></script>

        <link rel="stylesheet" type="text/css" href="static/css/bootstrap.min.css">
        <script src="static/js/bootstrap.min.js"></script>

        <script src="static/js/echarts.min.js"></script>

        <script src='static/js/ecStat.min.js'></script>

        <script src="static/js/jquery.dataTables.min.js"></script>
        <link rel="stylesheet" type="text/css" href="static/css/dataTables.bootstrap.min.css">
        <script src="static/js/dataTables.bootstrap.min.js"></script>
        <link rel="stylesheet" type="text/css" href="static/css/fixedColumns.bootstrap.min.css">
        <script src="static/js/dataTables.fixedColumns.min.js"></script>

        <link rel="stylesheet" type="text/css" href="css/main.css">

        <script src='js/aux.js'></script>
        <script src='js/multiselect.js'></script>
        <script src='js/visualize.js'></script>

        <script type="text/javascript">
            function cachedJSON(url, key, func) {
                var response;
                if (!Cookies.get('cached') || !localStorage.getItem(key)) {
                    $.getJSON(url, response => {
                        localStorage.setItem(key, JSON.stringify(response));
                        Cookies.set('cached', 'true', {expires: 1});

                        func(response);
                    });
                } else {
                    response = JSON.parse(localStorage.getItem(key));
                    func(response);
                }
            }

            $(document).ready(function() {
                improveMultiSelects();

                var loadMap = new Map();
                $(window).scroll(() => {
                    for (var [obj, f] of loadMap.entries()) {
                        if ($(obj).visible(true)) {
                            loadMap.delete(obj);
                            f();
                        }
                    }
                });

                cachedJSON("config.json", 'config', function(config) {
                    var host = config.host;

                    $(".vis").each(function() {
                        var id = $(this).attr('id');

                        var notReady = $(`#${id} select`).length;

                        var dataID = $(this).attr('data-id') || id;

                        var args = [];
                        var realArgs = [];

                        $(`#${id} select`).each(function() {
                            var argName = $(this).attr("data-arg");
                            args.push(argName);
                            var realArgName = $(this).attr("data-realarg");
                            realArgs.push(realArgName || argName);

                            cachedJSON(`http://${host}/${dataID}/${argName}`, `${dataID}/${argName}`, response => {
                                var list = response.data;
                                var options = "";
                                if (list.length == 0) {
                                    return;
                                }

                                var key = $(this).attr("data-key");

                                if (!key) {
                                    for (var i = 0; i < list.length; i++) {
                                        options += `<option value="${list[i]}">${list[i]}</option>`;
                                    }
                                }
                                else {
                                    _.map(_.groupBy(list, o => o.key), (l, g) => {
                                        options += `<optgroup label="${g}">`;

                                        localList = _.map(l, o => o.value);
                                        for (var i = 0; i < localList.length; i++) {
                                            options += `<option value="${localList[i]}">${localList[i]}</option>`;
                                        }

                                        options += `</optgroup>`;
                                    });
                                }

                                $(this).html(options);
                                var defaultPos = $(this).attr("data-default");
                                if (!defaultPos) {
                                    if ($(this).prop("multiple")) {
                                        $(this).find(`option`).prop("selected", true);
                                    }
                                    else {
                                        $(this).find(`option:first-of-type`).prop("selected", true);
                                    }
                                }
                                else {
                                    $(this).find(`option:nth-of-type(${defaultPos})`).prop("selected", true);
                                }

                                notReady -= 1;
                            });
                        });

                        function getArgStr() {
                            var argStr = "";
                            for (i = 0; i < args.length; i++) {
                                var key = args[i];
                                var realKey = realArgs[i];
                                var value = $(`#${id} select[data-arg=${key}]`).val();

                                if (i > 0) {
                                    argStr += '&';
                                }
                                if (Array.isArray(value)) {
                                    argStr += `${realKey}=` + value.join(`&${realKey}=`);
                                }
                                else {
                                    argStr += `${realKey}=${encodeURI(value)}`;
                                }
                            }

                            return argStr
                        }

                        function getAction(selector, func) {
                            var target = $(selector).attr("data-target") || "func";

                            return () => {
                                var argStr = getArgStr();
                                cachedJSON(`http://${host}/${dataID}/${target}?${argStr}`, `${dataID}/${target}?${argStr}`, func)
                            };
                        }

                        function init(obj) {
                            if (notReady > 0) {
                                setTimeout(() => init(obj), 400);

                                return;
                            }

                            if ($(obj).visible(true)) {
                                load(obj);
                            }
                            else {
                                loadMap.set(obj, () => load(obj));
                            }
                        }

                        function load(obj) {
                            if ($(obj).has(".vis-figure").length > 0) {
                                cachedJSON(`vis/${dataID}.json`, dataID, function(response) {
                                    var spec = response;

                                    var action = getAction(`#${id} .vis-figure`, function(response) {
                                        visualize(`#${id} .vis-figure`, spec, response.data);
                                    });

                                    $(`#${id} select`).change(action);
                                    action();
                                });
                            }

                            if ($(obj).has(".vis-table").length > 0) {
                                var table = null;

                                var action = getAction(`#${id} .vis-table`, function(response) {
                                    if (table) {
                                        table.destroy();
                                        $(`#${id} .vis-table`).empty();
                                    }

                                    table = $(`#${id} .vis-table`).DataTable({
                                        "data": _.rest(response.data),
                                        "columns": _.map(response.data[0], v => ({title: v})),
                                        "displayLength": -1,
                                        "paging": false,
                                        "ordering": false,
                                        "info": false,
                                        "searching": false,
                                        "scrollY": true,
                                        "scrollX": true,
                                        "scrollCollapse": true,
                                        "fixedColumns": true
                                    })
                                });

                                $(`#${id} select`).change(action);
                                action();
                            }
                        }

                        init(this);
                    });
                });
            });
        </script>
    </head>

    <body>
        <div class="container">
            <div class="vis" id="results_graph">
                <h3>Results Graph</h3>
                <table>
                    <tr>
                        <td>
                            <div class="vis-figure"></div>
                        </td>
                        <td>
                            Year
                            <select class="form-control input-sm" data-arg="year" data-default="7" size="10" multiple></select>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="vis" id="results_table" data-id="results_graph">
                <h3>Results Table</h3>
                <table>
                    <tr>
                        <td>
                            <table class="table table-hover table-condensed vis-table" data-target="func_table"></table>
                        </td>
                        <td>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="vis" id="opposition">
                <h3>Opposition</h3>
                <table>
                    <tr>
                        <td>
                            <div class="vis-figure"></div>
                            <div style="font-size: 12px">
                                <table class="table table-condensed vis-table" data-target="func_result"></table>
                            </div>
                        </td>
                        <td>
                            Measure
                            <select class="form-control input-sm" data-arg="measure" data-default="6"></select>
                            Opponent
                            <select class="form-control input-sm" data-arg="opponent"></select>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="vis" id="team_working_data_control" data-id="team_working_data">
                <h3>Team Working Data - Control</h3>
                <table>
                    <tr>
                        <td>
                            <div class="vis-figure"></div>
                        </td>
                        <td>
                            Control Measure
                            <select class="form-control input-sm" data-arg="control_measure" data-realarg="measure" data-default="2"></select>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="vis" id="team_working_data_process" data-id="team_working_data">
                <h3>Team Working Data - Process</h3>
                <table>
                    <tr>
                        <td>
                            <div class="vis-figure"></div>
                        </td>
                        <td>
                            Process Measure
                            <select class="form-control input-sm" data-arg="process_measure" data-realarg="measure" data-default="5"></select>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="vis" id="team_working_data_outcome" data-id="team_working_data">
                <h3>Team Working Data - Outcome</h3>
                <table>
                    <tr>
                        <td>
                            <div class="vis-figure"></div>
                        </td>
                        <td>
                            Outcome Measure
                            <select class="form-control input-sm" data-arg="outcome_measure" data-realarg="measure" data-default="12"></select>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="vis" id="team_working_data_final" data-id="team_working_data">
                <h3>Team Working Data - Final Acts Quality</h3>
                <table>
                    <tr>
                        <td>
                            <div class="vis-figure"></div>
                        </td>
                        <td>
                            Final Acts Quality Measure
                            <select class="form-control input-sm" data-arg="final_measure" data-realarg="measure" data-default="3"></select>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="vis" id="player_analysis_graph_control" data-id="player_analysis_graph">
                <h3>Player Analysis Graph - Control</h3>
                <table>
                    <tr>
                        <td>
                            <div class="vis-figure"></div>
                        </td>
                        <td>
                            Control Measure
                            <select class="form-control input-sm" data-arg="control_measure" data-realarg="measure" data-default="2"></select>
                            Minutes
                            <select class="form-control input-sm" data-arg="minutes" data-default="9"></select>
                            Podium
                            <div class="form-inline">
                                <select class="form-control input-sm" data-arg="podium_op" data-default="2"></select>
                                <select class="form-control input-sm" data-arg="podium" data-default="5"></select>
                            </div>
                            Players
                            <select class="form-control input-sm" data-arg="players" size="10" multiple></select>
                            Positions
                            <select class="form-control input-sm" data-arg="positions" size="4" multiple></select>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="vis" id="player_analysis_graph_process" data-id="player_analysis_graph">
                <h3>Player Analysis Graph - Process</h3>
                <table>
                    <tr>
                        <td>
                            <div class="vis-figure"></div>
                        </td>
                        <td>
                            Process Measure
                            <select class="form-control input-sm" data-arg="process_measure" data-realarg="measure" data-default="3"></select>
                            Minutes
                            <select class="form-control input-sm" data-arg="minutes" data-default="9"></select>
                            Podium
                            <div class="form-inline">
                                <select class="form-control input-sm" data-arg="podium_op" data-default="2"></select>
                                <select class="form-control input-sm" data-arg="podium" data-default="5"></select>
                            </div>
                            Players
                            <select class="form-control input-sm" data-arg="players" size="10" multiple></select>
                            Positions
                            <select class="form-control input-sm" data-arg="positions" size="4" multiple></select>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="vis" id="player_analysis_graph_outcome" data-id="player_analysis_graph">
                <h3>Player Analysis Graph - Outcome</h3>
                <table>
                    <tr>
                        <td>
                            <div class="vis-figure"></div>
                        </td>
                        <td>
                            Outcome Measure
                            <select class="form-control input-sm" data-arg="outcome_measure" data-realarg="measure" data-default="12"></select>
                            Minutes
                            <select class="form-control input-sm" data-arg="minutes" data-default="9"></select>
                            Podium
                            <div class="form-inline">
                                <select class="form-control input-sm" data-arg="podium_op" data-default="2"></select>
                                <select class="form-control input-sm" data-arg="podium" data-default="5"></select>
                            </div>
                            Players
                            <select class="form-control input-sm" data-arg="players" size="10" multiple></select>
                            Positions
                            <select class="form-control input-sm" data-arg="positions" size="4" multiple></select>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="vis" id="player_analysis_graph_final" data-id="player_analysis_graph">
                <h3>Player Analysis Graph - Final Acts Quality</h3>
                <table>
                    <tr>
                        <td>
                            <div class="vis-figure"></div>
                        </td>
                        <td>
                            Final Acts Quality Measure
                            <select class="form-control input-sm" data-arg="final_measure" data-realarg="measure" data-default="3"></select>
                            Minutes
                            <select class="form-control input-sm" data-arg="minutes" data-default="9"></select>
                            Podium
                            <div class="form-inline">
                                <select class="form-control input-sm" data-arg="podium_op" data-default="2"></select>
                                <select class="form-control input-sm" data-arg="podium" data-default="5"></select>
                            </div>
                            Players
                            <select class="form-control input-sm" data-arg="players" size="10" multiple></select>
                            Positions
                            <select class="form-control input-sm" data-arg="positions" size="4" multiple></select>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="vis" id="pass_completion_control" data-id="pass_completion">
                <h3>Pass Completion - Control</h3>
                <table>
                    <tr>
                        <td>
                            <div class="vis-figure"></div>
                        </td>
                        <td>
                            Control Measure
                            <select class="form-control input-sm" data-arg="control_measure" data-realarg="measure" data-default="2"></select>
                            Player
                            <select class="form-control input-sm" data-arg="player" data-key="key"></select>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="vis" id="pass_completion_process" data-id="pass_completion">
                <h3>Pass Completion - Process</h3>
                <table>
                    <tr>
                        <td>
                            <div class="vis-figure"></div>
                        </td>
                        <td>
                            Process Measure
                            <select class="form-control input-sm" data-arg="process_measure" data-realarg="measure" data-default="3"></select>
                            Player
                            <select class="form-control input-sm" data-arg="player" data-key="key"></select>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="vis" id="pass_completion_outcome_first" data-id="pass_completion">
                <h3>Pass Completion - Outcome</h3>
                <table>
                    <tr>
                        <td>
                            <div class="vis-figure"></div>
                        </td>
                        <td>
                            Outcome Measure
                            <select class="form-control input-sm" data-arg="outcome_measure_first" data-realarg="measure" data-default="7"></select>
                            Player
                            <select class="form-control input-sm" data-arg="player" data-key="key"></select>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="vis" id="pass_completion_outcome_second" data-id="pass_completion">
                <h3>Pass Completion - Outcome</h3>
                <table>
                    <tr>
                        <td>
                            <div class="vis-figure"></div>
                        </td>
                        <td>
                            Outcome Measure
                            <select class="form-control input-sm" data-arg="outcome_measure_second" data-realarg="measure" data-default="3"></select>
                            Player
                            <select class="form-control input-sm" data-arg="player" data-key="key"></select>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="vis" id="player_table">
                <h3>Player Table</h3>
                <table>
                    <tr>
                        <td>
                            <div style="overflow: scroll; width: 800px;">
                                <table class="table table-hover table-condensed vis-table"></table>
                            </div>
                        </td>
                        <td>
                            Minutes
                            <select class="form-control input-sm" data-arg="minutes" data-default="9"></select>
                            Positions
                            <select class="form-control input-sm" data-arg="positions" size="4" multiple></select>
                            Podium
                            <div class="form-inline">
                                <select class="form-control input-sm" data-arg="podium_op" data-default="2"></select>
                                <select class="form-control input-sm" data-arg="podium" data-default="5"></select>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </body>
</html>
