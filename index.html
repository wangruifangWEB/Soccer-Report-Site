<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">

        <script src="static/js/jquery.min.js"></script>
        <script src="static/js/jquery.visible.min.js"></script>

        <script src="static/js/js.cookie.js"></script>

        <script src="static/js/URI.min.js"></script>

        <script src="static/js/underscore-min.js"></script>

        <link rel="stylesheet" type="text/css" href="static/css/font-awesome.min.css">

        <link rel="stylesheet" type="text/css" href="static/css/bootstrap.min.css">
        <script src="static/js/bootstrap.min.js"></script>

        <script src="static/js/echarts.min.js"></script>

        <script src='static/js/ecStat.min.js'></script>

        <script src="static/js/jquery.dataTables.min.js"></script>
        <link rel="stylesheet" type="text/css" href="static/css/dataTables.bootstrap.min.css">
        <script src="static/js/dataTables.bootstrap.min.js"></script>
        <link rel="stylesheet" type="text/css" href="static/css/fixedColumns.bootstrap.min.css">
        <script src="static/js/dataTables.fixedColumns.min.js"></script>

        <link rel="stylesheet" type="text/css" href="css/main.css">

        <script src='js/aux.js'></script>
        <script src='js/multiselect.js'></script>
        <script src='js/select.js'></script>
        <script src='js/visualize.js'></script>

        <script type="text/javascript">
            function cachedJSON(url, func) {
                var response;
                if (!localStorage.getItem(url)) {
                    $.getJSON(url, response => {
                        localStorage.setItem(url, JSON.stringify(response));

                        func(response);
                    }).done(
                        () => $('#offlineAlert').fadeOut()
                    ).fail(
                        () => $('#offlineAlert').fadeIn()
                    );
                } else {
                    response = JSON.parse(localStorage.getItem(url));
                    func(response);
                }
            }

            $(document).ready(function() {
                var uri = URI(window.location.href);
                var globalPerGame = uri.query(true).pergame == 'true';
                $(`.nav li:nth-child(${!globalPerGame ? 1 : 2})`).addClass("active");

                var opponent = "";
                var date = "";
                $('#pergame_info_opponent').change(function() {
                    opponent = $(this).val();
                    date = "";
                });
                $('#pergame_info_date').change(function() {
                    date = $(this).val();
                });

                improveMultiSelects();
                improveSelects();

                $('[data-toggle="tooltip"]').tooltip();

                $(`.vis[data-pergame="${globalPerGame ? "regular" : "pergame"}"]`).hide();

                if (!Cookies.get('cached')) {
                    localStorage.clear();
                    Cookies.set('cached', 'true', {expires: 7});
                    $('#syncAlert').fadeIn();
                    setTimeout(() => $('#syncAlert').fadeOut(), 10000);
                }

                $("#refresh button").click(function() {
                    Cookies.remove('cached');
                    location.reload(true);
                });

                var loadMap = new Map();
                $(window).scroll(() => {
                    for (var [obj, f] of loadMap.entries()) {
                        if ($(obj).visible(true)) {
                            loadMap.delete(obj);
                            f();
                        }
                    }
                });

                cachedJSON("config.json", function(config) {
                    var host = config.host;

                    $(".vis").each(function() {
                        if (globalPerGame && $(this).data('pergame') == "regular") {
                            return;
                        }
                        if (!globalPerGame && $(this).data('pergame') == "pergame") {
                            return;
                        }

                        var perGame = $(this).data('pergame') != "regular";

                        var id = $(this).attr('id');

                        var notReady = $(`#${id} select`).length;

                        var dataID = $(this).data('id') || id;

                        var args = [];
                        var realArgs = [];

                        $(`#${id} select`).each(function() {
                            var argName = $(this).data("arg");
                            args.push(argName);
                            var realArgName = $(this).data("realarg");
                            realArgs.push(realArgName || argName);

                            var depends = $(this).data("depends");

                            function prepare(selectElem) {
                                var dependingStr = ""
                                if (depends) {
                                    dependingStr = "?" + _.map(depends.split(' '), s => s + "=" + $(`#${id} select[data-arg="${s}"]`).val()).join('&');
                                }

                                cachedJSON(`http://${host}/${dataID}/${argName}${dependingStr}`, response => {
                                    if (depends) {
                                        $(selectElem).addClass("updated");
                                        setTimeout(() => $(selectElem).removeClass("updated"), 400);
                                    }

                                    var list = response.data;
                                    var options = "";
                                    if (list.length == 0) {
                                        return;
                                    }

                                    var key = $(selectElem).data("key");

                                    if (!key) {
                                        _.each(list, o => {
                                            options += `<option value="${o}">${o}</option>`;
                                        });
                                    }
                                    else {
                                        _.each(_.filter(list, o => !o.key), o => {
                                            options += `<option value="${o.value}">${o.value}</option>`;
                                        });

                                        _.each(_.groupBy(_.filter(list, o => o.key), o => o.key), (l, g) => {
                                            options += `<optgroup label="${g}">`;

                                            _.each(l, o => {
                                                options += `<option value="${o.value}">${o.value}</option>`;
                                            });

                                            options += `</optgroup>`;
                                        });
                                    }

                                    $(selectElem).html(options);
                                    var defaultPos = parseInt($(selectElem).data("default"));
                                    if (!defaultPos) {
                                        if ($(selectElem).prop("multiple")) {
                                            $(selectElem).find(`option`).prop("selected", true);
                                        }
                                        else {
                                            $(selectElem).find(`option:first-of-type`).prop("selected", true);
                                        }
                                    }
                                    else {
                                        if (!key) {
                                            $(selectElem).find(`option:nth-${defaultPos >= 0 ? '' : 'last-'}of-type(${Math.abs(defaultPos)})`).prop("selected", true);
                                        }
                                        else {
                                            $(selectElem).find(`optgroup:nth-${defaultPos >= 0 ? '' : 'last-'}of-type(${Math.abs(defaultPos)}) > option:first-of-type`).prop("selected", true);
                                        }
                                    }
                                    $(selectElem).trigger("change");

                                    notReady -= 1;
                                });
                            }

                            prepare(this);

                            if (depends) {
                                _.each(depends.split(' '), s => $(`#${id} select[data-arg="${s}"]`).change(() => prepare(this)));
                            }
                        });

                        function getArgStr() {
                            var argStr = "";
                            for (i = 0; i < args.length; i++) {
                                var key = args[i];
                                var realKey = realArgs[i];
                                var value = $(`#${id} select[data-arg=${key}]`).val();

                                if (i > 0) {
                                    argStr += '&';
                                }
                                if (Array.isArray(value)) {
                                    argStr += `${realKey}=` + value.join(`&${realKey}=`);
                                }
                                else {
                                    argStr += `${realKey}=${encodeURI(value)}`;
                                }
                            }

                            return argStr
                        }

                        function getAction(selector, func) {
                            var target = $(selector).data("target") || "func";

                            return () => {
                                var perGameStr = globalPerGame && perGame ? `_opponent=${opponent}&_date=${date}&` : "";
                                var argStr = getArgStr();
                                cachedJSON(`http://${host}/${dataID}/${target}?${perGameStr}${argStr}`, func)
                            };
                        }

                        function init(obj) {
                            if (notReady > 0) {
                                setTimeout(() => init(obj), 400);

                                return;
                            }

                            if ($(obj).visible(true)) {
                                load(obj);
                            }
                            else {
                                loadMap.set(obj, () => load(obj));
                            }
                        }

                        function load(obj) {
                            if ($(obj).has(".vis-text").length > 0) {
                                var action = getAction(`#${id} .vis-text`, function(response) {
                                    var textObj = $(`#${id} .vis-text`);
                                    textObj.addClass("updated");
                                    setTimeout(() => textObj.removeClass("updated"), 400);

                                    textObj.html(response.data);
                                });

                                $(`#${id} select`).change(action);
                                if (globalPerGame && perGame) {
                                    $('#pergame_info_date').change(action);
                                }
                                action();
                            }

                            if ($(obj).has(".vis-figure").length > 0) {
                                cachedJSON(`vis/${dataID}.json`, function(response) {
                                    var spec = response;

                                    var action = getAction(`#${id} .vis-figure`, function(response) {
                                        visualize(`#${id} .vis-figure`, spec, response.data);
                                    });

                                    $(`#${id} select`).change(action);
                                    if (globalPerGame && perGame) {
                                        $('#pergame_info_date').change(action);
                                    }
                                    action();
                                });
                            }

                            if ($(obj).has(".vis-table").length > 0) {
                                var table = null;

                                var action = getAction(`#${id} .vis-table`, function(response) {
                                    var tableObj = $(`#${id} .vis-table`);

                                    if (table) {
                                        table.destroy();
                                        tableObj.empty();
                                    }

                                    var actives = tableObj.data("actives");

                                    table = tableObj.DataTable({
                                        "data": _.rest(response.data),
                                        "columns": _.map(response.data[0], v => ({title: v})),
                                        "displayLength": -1,
                                        "paging": false,
                                        "ordering": false,
                                        "info": false,
                                        "searching": false,
                                        "scrollY": true,
                                        "scrollX": true,
                                        "scrollCollapse": true,
                                        "fixedColumns": true
                                    });

                                    if (actives) {
                                        _.each(actives.split(' '), p => {
                                            $(`#${id} .vis-table tbody tr:nth-last-child(${-parseInt(p)})`).addClass('active');
                                        });
                                    }
                                });

                                $(`#${id} select`).change(action);
                                if (globalPerGame && perGame) {
                                    $('#pergame_info_date').change(action);
                                }
                                action();
                            }
                        }

                        init(this);
                    });
                });
            });
        </script>
    </head>

    <body>
        <div id="refresh">
            <button class="btn btn-default" data-toggle="tooltip" data-placement="left" title="Sync"><i class="fa fa-refresh"></i></button>
        </div>

        <div id="offlineAlert" class="alert alert-danger">
            <i class="fa fa-plane"></i> Offline.
        </div>

        <div id="syncAlert" class="alert alert-success">
            <i class="fa fa-refresh fa-spin"></i> Syncing...
        </div>

        <div class="container">
            <ul class="nav nav-pills nav-justified">
                <li role="presentation"><a href="/">Regular</a></li>
                <li role="presentation"><a href="/?pergame=true">Per Game</a></li>
            </ul>

            <div class="vis" id="pergame_info" data-pergame="pergame">
                <table>
                    <tr>
                        <td style="width: 400px; text-align: right">
                            <h1>
                                <span class="country">Canada</span>
                            </h1>
                        </td>
                        <td style="width: 200px; text-align: center">
                            <h3>
                                v.s.
                            </h3>
                        </td>
                        <td style="width: 400px">
                            <h1>
                                <select id="pergame_info_opponent" class="country form-control" data-arg="opponent"></select>
                            </h1>
                        </td>
                    </tr>
                    <tr>
                        <td style="text-align: right">
                            <h3>
                                <span class="vis-text"></span>
                            </h3>
                        </td>
                        <td>
                        </td>
                        <td>
                            <h3>
                                <select id="pergame_info_date" class="form-control input-sm" data-arg="date" data-depends="opponent" data-key="nolabel" data-default="-1"></select>
                            </h3>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="vis" id="results_graph" data-pergame="regular">
                <h3>Results</h3>
                <table>
                    <tr>
                        <td>
                            <div class="vis-figure"></div>
                        </td>
                        <td>
                            <label>Year</label>
                            <select class="form-control input-sm" data-arg="year" data-default="7" size="10" multiple></select>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="vis" id="results_table" data-id="results_graph" data-pergame="regular">
                <table>
                    <tr>
                        <td>
                            <table class="table table-hover table-condensed vis-table" data-target="func_table"></table>
                        </td>
                        <td>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="vis" id="opposition_regular" data-id="opposition" data-pergame="regular">
                <h3>Opposition Analysis</h3>
                <table>
                    <tr>
                        <td>
                            <div class="vis-figure"></div>
                            <div style="font-size: 12px">
                                <table class="table table-condensed vis-table" data-target="func_result"></table>
                            </div>
                        </td>
                        <td>
                            <label>Measure</label>
                            <select class="form-control input-sm" data-arg="measure" data-default="6"></select>
                            <label>Opponent</label>
                            <select class="form-control input-sm" data-arg="opponent"></select>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="vis" id="opposition_pergame" data-id="opposition" data-pergame="pergame">
                <h3>Opposition Analysis</h3>
                <table>
                    <tr>
                        <td>
                            <div class="vis-figure"></div>
                            <div style="font-size: 12px">
                                <table class="table table-condensed vis-table" data-target="func_result"></table>
                            </div>
                        </td>
                        <td>
                            <label>Measure</label>
                            <select class="form-control input-sm" data-arg="measure" data-default="6"></select>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="vis" id="team_working_data_control" data-id="team_working_data" data-pergame="both">
                <h3>Team Trends - Control</h3>
                <table>
                    <tr>
                        <td>
                            <div class="vis-figure"></div>
                        </td>
                        <td>
                            <label>Control Measure</label>
                            <select class="form-control input-sm" data-arg="control_measure" data-realarg="measure" data-default="2"></select>
                            <label>Podium Threat</label>
                            <div class="form-inline">
                                <select class="form-control input-sm" data-arg="podium_op"></select>
                                <select class="form-control input-sm" data-arg="podium" data-default="5"></select>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="vis" id="team_working_data_process" data-id="team_working_data" data-pergame="both">
                <h3>Team Trends - Process</h3>
                <table>
                    <tr>
                        <td>
                            <div class="vis-figure"></div>
                        </td>
                        <td>
                            <label>Process Measure</label>
                            <select class="form-control input-sm" data-arg="process_measure" data-realarg="measure" data-default="5"></select>
                            <label>Podium Threat</label>
                            <div class="form-inline">
                                <select class="form-control input-sm" data-arg="podium_op"></select>
                                <select class="form-control input-sm" data-arg="podium" data-default="5"></select>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="vis" id="team_working_data_outcome" data-id="team_working_data" data-pergame="both">
                <h3>Team Trends - Outcome</h3>
                <table>
                    <tr>
                        <td>
                            <div class="vis-figure"></div>
                        </td>
                        <td>
                            <label>Outcome Measure</label>
                            <select class="form-control input-sm" data-arg="outcome_measure" data-realarg="measure" data-default="12"></select>
                            <label>Podium Threat</label>
                            <div class="form-inline">
                                <select class="form-control input-sm" data-arg="podium_op"></select>
                                <select class="form-control input-sm" data-arg="podium" data-default="5"></select>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="vis" id="team_working_data_final" data-id="team_working_data" data-pergame="both">
                <h3>Team Trends - Final Acts Quality</h3>
                <table>
                    <tr>
                        <td>
                            <div class="vis-figure"></div>
                        </td>
                        <td>
                            <label>Final Acts Quality Measure</label>
                            <select class="form-control input-sm" data-arg="final_measure" data-realarg="measure" data-default="3"></select>
                            <label>Podium Threat</label>
                            <div class="form-inline">
                                <select class="form-control input-sm" data-arg="podium_op"></select>
                                <select class="form-control input-sm" data-arg="podium" data-default="5"></select>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="vis" id="player_analysis_graph_control" data-id="player_analysis_graph" data-pergame="both">
                <h3>Player Analysis - Control</h3>
                <table>
                    <tr>
                        <td>
                            <div class="vis-figure"></div>
                        </td>
                        <td>
                            <label>Control Measure</label>
                            <select class="form-control input-sm" data-arg="control_measure" data-realarg="measure" data-default="2"></select>
                            <label>Podium Threat</label>
                            <div class="form-inline">
                                <select class="form-control input-sm" data-arg="podium_op"></select>
                                <select class="form-control input-sm" data-arg="podium" data-default="5"></select>
                            </div>
                            <label>Players</label>
                            <select class="form-control input-sm" data-arg="players" data-key="nolabel" size="10" multiple></select>
                            <label>Minutes Played</label>
                            <select class="form-control input-sm" data-arg="minutes" size="6" multiple></select>
                            <label>Positions</label>
                            <select class="form-control input-sm" data-arg="positions" data-default="3" size="4" multiple></select>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="vis" id="player_analysis_graph_process" data-id="player_analysis_graph" data-pergame="both">
                <h3>Player Analysis - Process</h3>
                <table>
                    <tr>
                        <td>
                            <div class="vis-figure"></div>
                        </td>
                        <td>
                            <label>Process Measure</label>
                            <select class="form-control input-sm" data-arg="process_measure" data-realarg="measure" data-default="3"></select>
                            <label>Podium Threat</label>
                            <div class="form-inline">
                                <select class="form-control input-sm" data-arg="podium_op"></select>
                                <select class="form-control input-sm" data-arg="podium" data-default="5"></select>
                            </div>
                            <label>Players</label>
                            <select class="form-control input-sm" data-arg="players" data-key="nolabel" size="10" multiple></select>
                            <label>Minutes Played</label>
                            <select class="form-control input-sm" data-arg="minutes" size="6" multiple></select>
                            <label>Positions</label>
                            <select class="form-control input-sm" data-arg="positions" data-default="3" size="4" multiple></select>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="vis" id="player_analysis_graph_outcome" data-id="player_analysis_graph" data-pergame="both">
                <h3>Player Analysis - Outcome</h3>
                <table>
                    <tr>
                        <td>
                            <div class="vis-figure"></div>
                        </td>
                        <td>
                            <label>Outcome Measure</label>
                            <select class="form-control input-sm" data-arg="outcome_measure" data-realarg="measure" data-default="12"></select>
                            <label>Podium Threat</label>
                            <div class="form-inline">
                                <select class="form-control input-sm" data-arg="podium_op"></select>
                                <select class="form-control input-sm" data-arg="podium" data-default="5"></select>
                            </div>
                            <label>Players</label>
                            <select class="form-control input-sm" data-arg="players" data-key="nolabel" size="10" multiple></select>
                            <label>Minutes Played</label>
                            <select class="form-control input-sm" data-arg="minutes" size="6" multiple></select>
                            <label>Positions</label>
                            <select class="form-control input-sm" data-arg="positions" data-default="3" size="4" multiple></select>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="vis" id="player_analysis_graph_final" data-id="player_analysis_graph" data-pergame="both">
                <h3>Player Analysis - Final Acts Quality</h3>
                <table>
                    <tr>
                        <td>
                            <div class="vis-figure"></div>
                        </td>
                        <td>
                            <label>Final Acts Quality Measure</label>
                            <select class="form-control input-sm" data-arg="final_measure" data-realarg="measure" data-default="3"></select>
                            <label>Podium Threat</label>
                            <div class="form-inline">
                                <select class="form-control input-sm" data-arg="podium_op"></select>
                                <select class="form-control input-sm" data-arg="podium" data-default="5"></select>
                            </div>
                            <label>Players</label>
                            <select class="form-control input-sm" data-arg="players" data-key="nolabel" size="10" multiple></select>
                            <label>Minutes Played</label>
                            <select class="form-control input-sm" data-arg="minutes" size="6" multiple></select>
                            <label>Positions</label>
                            <select class="form-control input-sm" data-arg="positions" data-default="3" size="4" multiple></select>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="vis" id="pass_completion_control" data-id="pass_completion" data-pergame="both">
                <h3>Player Trends - Control</h3>
                <table>
                    <tr>
                        <td>
                            <div class="vis-figure"></div>
                        </td>
                        <td>
                            <label>Control Measure</label>
                            <select class="form-control input-sm" data-arg="control_measure" data-realarg="measure" data-default="2"></select>
                            <label>Player</label>
                            <select class="form-control input-sm" data-arg="player" data-key="label" data-default="3"></select>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="vis" id="pass_completion_process" data-id="pass_completion" data-pergame="both">
                <h3>Player Trends - Process</h3>
                <table>
                    <tr>
                        <td>
                            <div class="vis-figure"></div>
                        </td>
                        <td>
                            <label>Process Measure</label>
                            <select class="form-control input-sm" data-arg="process_measure" data-realarg="measure" data-default="3"></select>
                            <label>Player</label>
                            <select class="form-control input-sm" data-arg="player" data-key="label" data-default="3"></select>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="vis" id="pass_completion_outcome_first" data-id="pass_completion" data-pergame="both">
                <h3>Player Trends - Outcome</h3>
                <table>
                    <tr>
                        <td>
                            <div class="vis-figure"></div>
                        </td>
                        <td>
                            <label>Outcome Measure</label>
                            <select class="form-control input-sm" data-arg="outcome_measure_first" data-realarg="measure" data-default="7"></select>
                            <label>Player</label>
                            <select class="form-control input-sm" data-arg="player" data-key="label" data-default="3"></select>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="vis" id="pass_completion_outcome_second" data-id="pass_completion" data-pergame="both">
                <h3>Player Trends - Outcome</h3>
                <table>
                    <tr>
                        <td>
                            <div class="vis-figure"></div>
                        </td>
                        <td>
                            <label>Outcome Measure</label>
                            <select class="form-control input-sm" data-arg="outcome_measure_second" data-realarg="measure" data-default="3"></select>
                            <label>Player</label>
                            <select class="form-control input-sm" data-arg="player" data-key="label" data-default="3"></select>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="vis" id="player_table" data-pergame="both">
                <h3>Player Statistics</h3>
                <table>
                    <tr>
                        <td>
                            <div style="overflow: scroll;">
                                <table class="table table-hover table-condensed vis-table" data-actives="-3 -2 -1"></table>
                            </div>
                        </td>
                        <td>
                            <label>Podium Threat</label>
                            <div class="form-inline">
                                <select class="form-control input-sm" data-arg="podium_op"></select>
                                <select class="form-control input-sm" data-arg="podium" data-default="5"></select>
                            </div>
                            <label>Minutes Played</label>
                            <select class="form-control input-sm" data-arg="minutes" size="6" multiple></select>
                            <label>Positions</label>
                            <select class="form-control input-sm" data-arg="positions" size="4" multiple></select>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </body>
</html>
